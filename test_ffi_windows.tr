# Test FFI on Windows
# Tests loading and using native Windows libraries

print("================================================")
print("TAURARO FFI WINDOWS LIBRARY TEST")
print("================================================")
print()

import sys

# Verify we're on Windows
if sys.platform != "win32":
    print(f"ERROR: This test requires Windows, running on {sys.platform}")
    exit(1)

# Test 1: Load kernel32.dll and get system information
print("[TEST 1] Loading kernel32.dll")
try:
    load_library("kernel32")
    print("✓ kernel32.dll loaded successfully")
except Exception as e:
    print(f"✗ Failed to load kernel32: {e}")
    exit(1)

print()
print("[TEST 2] GetTickCount - System uptime")
try:
    define_function("kernel32", "GetTickCount", "uint32", [])
    ticks = call_function("kernel32", "GetTickCount", [])
    uptime_seconds = ticks / 1000
    uptime_minutes = uptime_seconds / 60
    uptime_hours = uptime_minutes / 60
    print(f"✓ System uptime: {int(uptime_hours)}h {int(uptime_minutes % 60)}m {int(uptime_seconds % 60)}s")
    print(f"  Total milliseconds: {ticks}")
except Exception as e:
    print(f"✗ GetTickCount failed: {e}")

print()
print("[TEST 3] GetCurrentProcessId - Process ID")
try:
    define_function("kernel32", "GetCurrentProcessId", "uint32", [])
    pid = call_function("kernel32", "GetCurrentProcessId", [])
    print(f"✓ Current process ID: {pid}")
except Exception as e:
    print(f"✗ GetCurrentProcessId failed: {e}")

print()
print("[TEST 4] GetCurrentThreadId - Thread ID")
try:
    define_function("kernel32", "GetCurrentThreadId", "uint32", [])
    tid = call_function("kernel32", "GetCurrentThreadId", [])
    print(f"✓ Current thread ID: {tid}")
except Exception as e:
    print(f"✗ GetCurrentThreadId failed: {e}")

# Test 5: Load msvcrt.dll and test math functions
print()
print("[TEST 5] Loading msvcrt.dll (C Runtime)")
try:
    load_library("msvcrt")
    print("✓ msvcrt.dll loaded successfully")
except Exception as e:
    print(f"✗ Failed to load msvcrt: {e}")
    exit(1)

print()
print("[TEST 6] sqrt() - Square root function")
try:
    define_function("msvcrt", "sqrt", "double", ["double"])
    result = call_function("msvcrt", "sqrt", [144.0])
    print(f"✓ sqrt(144.0) = {result}")
    
    result2 = call_function("msvcrt", "sqrt", [2.0])
    print(f"✓ sqrt(2.0) = {result2}")
except Exception as e:
    print(f"✗ sqrt() failed: {e}")

print()
print("[TEST 7] pow() - Power function")
try:
    define_function("msvcrt", "pow", "double", ["double", "double"])
    result = call_function("msvcrt", "pow", [2.0, 10.0])
    print(f"✓ pow(2.0, 10.0) = {result}")
    
    result2 = call_function("msvcrt", "pow", [3.0, 3.0])
    print(f"✓ pow(3.0, 3.0) = {result2}")
except Exception as e:
    print(f"✗ pow() failed: {e}")

print()
print("[TEST 8] strlen() - String length")
try:
    define_function("msvcrt", "strlen", "size_t", ["string"])
    
    strings = ["Hello", "World", "Tauraro FFI Test", ""]
    for s in strings:
        length = call_function("msvcrt", "strlen", [s])
        print(f"✓ strlen('{s}') = {length}")
except Exception as e:
    print(f"✗ strlen() failed: {e}")

# Test 9: Test ExternFunction object (define once, call multiple times)
print()
print("[TEST 9] ExternFunction - Reusing function objects")
try:
    sqrt_func = define_function("msvcrt", "sqrt", "double", ["double"])
    pow_func = define_function("msvcrt", "pow", "double", ["double", "double"])
    
    sqrt_results = []
    for i in range(1, 5):
        # Call with individual arguments, not list
        result = call_function("msvcrt", "sqrt", [float(i * i)])
        sqrt_results.append(result)
        print(f"✓ sqrt({i}^2) = {result}")
    
    pow_results = []
    for i in range(1, 4):
        result = call_function("msvcrt", "pow", [2.0, float(i)])
        pow_results.append(result)
        print(f"✓ 2^{i} = {result}")
except Exception as e:
    print(f"✗ ExternFunction test failed: {e}")

# Test 10: List loaded libraries
print()
print("[TEST 10] list_libraries() - Check loaded libraries")
try:
    libs = list_libraries()
    print(f"✓ Loaded libraries: {libs}")
except Exception as e:
    print(f"✗ list_libraries() failed: {e}")

# Test 11: Library info
print()
print("[TEST 11] library_info() - Get library details")
try:
    info = library_info("kernel32")
    print(f"✓ kernel32 info retrieved")
    if info:
        print(f"  Name: {info.get('name', 'N/A')}")
        if 'path' in info:
            print(f"  Path: {info['path']}")
except Exception as e:
    print(f"✗ library_info() failed: {e}")

print()
print("================================================")
print("FFI WINDOWS TEST COMPLETED SUCCESSFULLY!")
print("================================================")
