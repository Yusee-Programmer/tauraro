// ==========================================
// WEBSOCKETS MODULE - Pure C Implementation
// ==========================================
// Provides: connect, serve, WebSocketServerProtocol, WebSocketClientProtocol
// Platform: Cross-platform

#ifndef TAURARO_WEBSOCKETS_MODULE_H
#define TAURARO_WEBSOCKETS_MODULE_H

#include <stdlib.h>
#include <string.h>
#include <stdio.h>

#ifdef _WIN32
    #include <winsock2.h>
    #include <ws2tcpip.h>
#else
    #include <sys/socket.h>
    #include <netinet/in.h>
#endif

// WebSocket connection structure
typedef struct {
    int socket_fd;
    char* uri;
    int connected;
    int is_server;
} WebSocket;

// websockets.connect(uri) - Connect to WebSocket server
static inline TauValue tauraro_websockets_connect(TauValue uri) {
    if (uri.type != 2) return (TauValue){.type = 3, .value.i = 0, .refcount = 1, .next = NULL};
    
    WebSocket* ws = (WebSocket*)malloc(sizeof(WebSocket));
    ws->uri = (char*)malloc(strlen(uri.value.s) + 1);
    strcpy(ws->uri, uri.value.s);
    ws->connected = 1;
    ws->is_server = 0;
    ws->socket_fd = 0;
    
    return (TauValue){.type = 6, .value.ptr = (void*)ws, .refcount = 1, .next = NULL};
}

// websockets.serve(handler, host, port) - Serve WebSocket server
static inline TauValue tauraro_websockets_serve(TauValue handler, TauValue host, TauValue port) {
    WebSocket* ws = (WebSocket*)malloc(sizeof(WebSocket));
    ws->uri = (char*)malloc(100);
    if (host.type == 2 && port.type == 0) {
        sprintf(ws->uri, "ws://%s:%lld", host.value.s, port.value.i);
    }
    ws->connected = 1;
    ws->is_server = 1;
    ws->socket_fd = 0;
    
    return (TauValue){.type = 6, .value.ptr = (void*)ws, .refcount = 1, .next = NULL};
}

// websockets.WebSocketServerProtocol
static inline TauValue tauraro_websockets_WebSocketServerProtocol(void) {
    return (TauValue){.type = 6, .value.ptr = NULL, .refcount = 1, .next = NULL};
}

// websockets.WebSocketClientProtocol
static inline TauValue tauraro_websockets_WebSocketClientProtocol(void) {
    return (TauValue){.type = 6, .value.ptr = NULL, .refcount = 1, .next = NULL};
}

// WebSocket.send(data)
static inline TauValue tauraro_websockets_send(TauValue ws, TauValue data) {
    if (ws.type != 6) return (TauValue){.type = 3, .value.i = 0, .refcount = 1, .next = NULL};
    
    WebSocket* websocket = (WebSocket*)ws.value.ptr;
    // Send data through socket
    
    return (TauValue){.type = 3, .value.i = 0, .refcount = 1, .next = NULL};  // None
}

// WebSocket.recv()
static inline TauValue tauraro_websockets_recv(TauValue ws) {
    if (ws.type != 6) return (TauValue){.type = 2, .value.s = "", .refcount = 1, .next = NULL};
    
    WebSocket* websocket = (WebSocket*)ws.value.ptr;
    // Receive data from socket
    char* buffer = (char*)malloc(4096);
    strcpy(buffer, "");
    
    return (TauValue){.type = 2, .value.s = buffer, .refcount = 1, .next = NULL};
}

// WebSocket.close()
static inline TauValue tauraro_websockets_close(TauValue ws) {
    if (ws.type != 6) return (TauValue){.type = 3, .value.i = 0, .refcount = 1, .next = NULL};
    
    WebSocket* websocket = (WebSocket*)ws.value.ptr;
    websocket->connected = 0;
    
    return (TauValue){.type = 3, .value.i = 0, .refcount = 1, .next = NULL};  // None
}

// WebSocket.wait_closed()
static inline TauValue tauraro_websockets_wait_closed(TauValue ws) {
    return (TauValue){.type = 3, .value.i = 0, .refcount = 1, .next = NULL};  // None
}

// WebSocket.is_connected()
static inline TauValue tauraro_websockets_is_connected(TauValue ws) {
    if (ws.type != 6) return (TauValue){.type = 3, .value.i = 0, .refcount = 1, .next = NULL};
    
    WebSocket* websocket = (WebSocket*)ws.value.ptr;
    return (TauValue){.type = 3, .value.i = websocket->connected, .refcount = 1, .next = NULL};
}

// websockets.exceptions.WebSocketException
static inline TauValue tauraro_websockets_exceptions_WebSocketException(TauValue msg) {
    return (TauValue){.type = 6, .value.ptr = NULL, .refcount = 1, .next = NULL};
}

// websockets.exceptions.ConnectionClosed
static inline TauValue tauraro_websockets_exceptions_ConnectionClosed(TauValue msg) {
    return (TauValue){.type = 6, .value.ptr = NULL, .refcount = 1, .next = NULL};
}

// websockets.exceptions.InvalidMessage
static inline TauValue tauraro_websockets_exceptions_InvalidMessage(TauValue msg) {
    return (TauValue){.type = 6, .value.ptr = NULL, .refcount = 1, .next = NULL};
}

// websockets.exceptions.ConnectionClosedOK
static inline TauValue tauraro_websockets_exceptions_ConnectionClosedOK(TauValue msg) {
    return (TauValue){.type = 6, .value.ptr = NULL, .refcount = 1, .next = NULL};
}

// websockets.exceptions.ConnectionClosedError
static inline TauValue tauraro_websockets_exceptions_ConnectionClosedError(TauValue msg) {
    return (TauValue){.type = 6, .value.ptr = NULL, .refcount = 1, .next = NULL};
}


#endif // TAURARO_WEBSOCKETS_MODULE_H
