# Comprehensive System Programming Test for Tauraro
# Tests all system programming features in compiled mode

# ==========================================
# Test 1: Basic Memory Management
# ==========================================
def test_memory_management():
    print("--- Test 1: Memory Management ---")
    
    # Allocate memory
    buffer = allocate(1024)
    print("Allocated 1024 bytes")
    
    # Get size info
    sz = sizeof(42)
    print("sizeof(int) estimate: " + str(sz))
    
    # Free memory
    free(buffer)
    print("Freed buffer")
    
    # Memory stats
    stats = memory_stats()
    print("Memory stats: " + str(stats))
    return 1

# ==========================================
# Test 2: Arena Memory
# ==========================================
def test_arena():
    print("--- Test 2: Arena Memory ---")
    
    # Create arena
    create_arena("test_arena")
    print("Created arena")
    
    # Allocate buffers
    buf1 = allocate(256)
    buf2 = allocate(512)
    print("Allocated 768 bytes in arena")
    
    # Reset arena
    reset_arena("test_arena")
    print("Reset arena")
    
    # Destroy arena
    destroy_arena("test_arena")
    print("Destroyed arena")
    return 1

# ==========================================
# Test 3: Pointer Operations
# ==========================================
def test_pointers():
    print("--- Test 3: Pointer Operations ---")
    
    # Null pointer
    ptr = null_ptr()
    is_n = is_null(ptr)
    print("null_ptr() is null: " + str(is_n))
    
    # Allocate and read/write
    buf = allocate(64)
    ptr_write(buf, 42, 8)
    val = ptr_read(buf, 8)
    print("Wrote 42, read back: " + str(val))
    
    # Pointer offset
    ptr2 = ptr_offset(buf, 8)
    ptr_write(ptr2, 100, 8)
    val2 = ptr_read(ptr2, 8)
    print("At offset 8, wrote 100, read: " + str(val2))
    
    free(buf)
    print("Freed buffer")
    return 1

# ==========================================
# Test 4: Memory Operations
# ==========================================
def test_mem_ops():
    print("--- Test 4: Memory Operations ---")
    
    # Allocate two buffers
    src = allocate(32)
    dest = allocate(32)
    
    # Write to source
    ptr_write(src, 123, 8)
    ptr_write(ptr_offset(src, 8), 456, 8)
    
    # Copy memory
    copy_memory(dest, src, 32)
    
    # Read from dest
    v1 = ptr_read(dest, 8)
    v2 = ptr_read(ptr_offset(dest, 8), 8)
    print("Copied values: " + str(v1) + ", " + str(v2))
    
    # Compare memory
    cmp = compare_memory(src, dest, 32)
    print("Memory compare result: " + str(cmp))
    
    # Zero memory
    zero_memory(dest, 32)
    v_zero = ptr_read(dest, 8)
    print("After zero_memory: " + str(v_zero))
    
    free(src)
    free(dest)
    return 1

# ==========================================
# Test 5: Volatile Operations
# ==========================================
def test_volatile():
    print("--- Test 5: Volatile Operations ---")
    
    # Allocate memory for volatile access
    buf = allocate(16)
    
    # Volatile write
    volatile_write(buf, 999)
    
    # Volatile read
    val = volatile_read(buf)
    print("Volatile wrote 999, read: " + str(val))
    
    free(buf)
    return 1

# ==========================================
# Test 6: Atomic Operations
# ==========================================
def test_atomics():
    print("--- Test 6: Atomic Operations ---")
    
    # Allocate aligned memory for atomics
    buf = allocate(16)
    
    # Zero the memory first
    zero_memory(buf, 16)
    
    # Atomic store
    atomic_store(buf, 100)
    
    # Atomic load
    val = atomic_load(buf)
    print("Atomic store 100, load: " + str(val))
    
    # Atomic add
    old = atomic_add(buf, 50)
    new_val = atomic_load(buf)
    print("Atomic add 50: old=" + str(old) + ", new=" + str(new_val))
    
    # Atomic sub
    old2 = atomic_sub(buf, 25)
    new_val2 = atomic_load(buf)
    print("Atomic sub 25: old=" + str(old2) + ", new=" + str(new_val2))
    
    # Atomic CAS (compare and swap)
    success = atomic_cas(buf, 125, 200)
    final_val = atomic_load(buf)
    print("Atomic CAS(125->200): success=" + str(success) + ", value=" + str(final_val))
    
    free(buf)
    return 1

# ==========================================
# Test 7: Cache & Performance
# ==========================================
def test_cache():
    print("--- Test 7: Cache & Performance ---")
    
    # Get cache line size
    line_size = cache_line_size()
    print("Cache line size: " + str(line_size) + " bytes")
    
    # Allocate buffer
    buf = allocate(256)
    
    # Prefetch memory (hint to CPU)
    prefetch(buf)
    print("Prefetched memory")
    
    # Memory barrier
    memory_barrier()
    print("Memory barrier inserted")
    
    free(buf)
    return 1

# ==========================================
# Test 8: Bit Cast
# ==========================================
def test_bit_cast():
    print("--- Test 8: Bit Cast ---")
    
    # Float to int bit cast
    f = 3.14
    i = bit_cast(f, "int")
    print("bit_cast(3.14, 'int'): " + str(i))
    
    # Int to float bit cast
    f2 = bit_cast(i, "float")
    print("bit_cast back to float: " + str(f2))
    
    return 1

# ==========================================
# Main Test Runner
# ==========================================
print("=== Comprehensive System Programming Test ===")
print("")

r1: int = test_memory_management()
print("")

r2: int = test_arena()
print("")

r3: int = test_pointers()
print("")

r4: int = test_mem_ops()
print("")

r5: int = test_volatile()
print("")

r6: int = test_atomics()
print("")

r7: int = test_cache()
print("")

r8: int = test_bit_cast()
print("")

print("=== All System Programming Tests Completed ===")
